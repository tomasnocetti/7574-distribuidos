
version: '3'
services:
  rabbitmq:
    container_name: rabbitmq
    build: rabbitmq/.
    ports:
      - 5672:5672
      - 15672:15672
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:15672']
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: none
  client:
    container_name: client
    build:
      context: ./
      dockerfile: ./client/Dockerfile
    entrypoint: /bin/sh -c 'while sleep 1000; do :; done'
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - LOGGING_LEVEL=INFO
      - FILE_READER_LINES=20
      - THUMBNAIL_PATH=.temp
    volumes:
      - ./raw_data:/workspace/data
      - ./.temp:/workspace/.temp
  tag_unique:
    container_name: tag_unique
    build:
      context: ./
      dockerfile: ./tag_unique/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=tag_unique
      - LOGGING_LEVEL=INFO
  trending_router:
    container_name: trending_router
    build:
      context: ./
      dockerfile: ./trending_router/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=trending_router
      - LOGGING_LEVEL=INFO
      - TRENDING_INSTANCES=2
  thumbnail_router:
    container_name: thumbnail_router
    build:
      context: ./
      dockerfile: ./thumbnail_router/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=thumbnail_router
      - LOGGING_LEVEL=INFO
      - INSTANCES=2
  trending_top:
    container_name: trending_top
    build:
      context: ./
      dockerfile: ./trending_top/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=trending_top
      - LOGGING_LEVEL=INFO
      - TRENDING_INSTANCES=2
  downloader:
    container_name: downloader
    build:
      context: ./
      dockerfile: ./downloader/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=downloader
      - LOGGING_LEVEL=INFO
      - THUMBNAIL_INSTANCES=2
  joiner_0:
    container_name: joiner_0
    build:
      context: ./
      dockerfile: ./joiner/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=joiner_0
      - LOGGING_LEVEL=INFO
  joiner_1:
    container_name: joiner_1
    build:
      context: ./
      dockerfile: ./joiner/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=joiner_1
      - LOGGING_LEVEL=INFO
  dropper_0:
    container_name: dropper_0
    build:
      context: ./
      dockerfile: ./dropper/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=dropper_0
      - LOGGING_LEVEL=INFO
  dropper_1:
    container_name: dropper_1
    build:
      context: ./
      dockerfile: ./dropper/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=dropper_1
      - LOGGING_LEVEL=INFO
  like_filter_0:
    container_name: like_filter_0
    build:
      context: ./
      dockerfile: ./likes_filter/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - LOGGING_LEVEL=INFO
      - SERVICE_ID=like_filter_0
      - FILTER_QTY=5000000
  like_filter_1:
    container_name: like_filter_1
    build:
      context: ./
      dockerfile: ./likes_filter/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - LOGGING_LEVEL=INFO
      - SERVICE_ID=like_filter_1
      - FILTER_QTY=5000000
  trending_0:
    container_name: trending_0
    build:
      context: ./
      dockerfile: ./trending_instance/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=trending_0
      - LOGGING_LEVEL=INFO
      - INSTANCE_NR=0
  trending_1:
    container_name: trending_1
    build:
      context: ./
      dockerfile: ./trending_instance/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=trending_1
      - LOGGING_LEVEL=INFO
      - INSTANCE_NR=1
  thumbnail_0:
    container_name: thumbnail_0
    build:
      context: ./
      dockerfile: ./thumbnail_instance/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=thumbnail_0
      - LOGGING_LEVEL=INFO
      - INSTANCE_NR=0
  thumbnail_1:
    container_name: thumbnail_1
    build:
      context: ./
      dockerfile: ./thumbnail_instance/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=thumbnail_1
      - LOGGING_LEVEL=INFO
      - INSTANCE_NR=1
  watcher_0:
    container_name: watcher_0
    build:
      context: ./
      dockerfile: ./watcher/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=watcher_0
      - LOGGING_LEVEL=INFO
      - INSTANCE_ID=0
      - JOINER_INSTANCES=2
      - DROPPER_INSTANCES=2
      - TRENDING_INSTANCES=2
      - LIKE_FILTER_INSTANCES=2
      - WATCHERS_INSTANCES=2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  watcher_1:
    container_name: watcher_1
    build:
      context: ./
      dockerfile: ./watcher/Dockerfile
    entrypoint: python3 main.py
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBIT_SERVER_ADDRESS=rabbitmq
      - SERVICE_ID=watcher_1
      - LOGGING_LEVEL=INFO
      - INSTANCE_ID=1
      - JOINER_INSTANCES=2
      - DROPPER_INSTANCES=2
      - TRENDING_INSTANCES=2
      - LIKE_FILTER_INSTANCES=2
      - WATCHERS_INSTANCES=2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
